class Solution {
    public int[] longestObstacleCourseAtEachPosition(int[] obstacles) {
        TreeMap<Integer, Integer> heights = new TreeMap<>();
        int n = obstacles.length;
        int[] res = new int[n];
        for (int i = 0; i < n; i++) {
            int h = obstacles[i];
            if (heights.floorKey(h) == null) res[i] = 1;
            else res[i] = heights.get(heights.floorKey(h)) + 1;
            heights.put(h, res[i]);
            while (true) {
                Map.Entry<Integer, Integer> entry = heights.higherEntry(h);
                if (entry == null || entry.getValue() > res[i]) break;
                heights.remove(entry.getKey());
            }
        }
        return res;
    }
}